<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sales Summary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="min-h-screen bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="sticky top-0 z-10 bg-gray-800 text-white shadow">
        <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
            <div class="text-xl font-bold">Sales Summary</div>
            <div class="ml-auto flex gap-3">
                <a href="index.html"
                    class="px-3 py-1.5 bg-emerald-600 rounded-lg text-white text-sm font-medium hover:bg-emerald-700 transition">
                    Back to POS
                </a>
                <button id="clearAllBtn"
                    class="px-3 py-1.5 bg-rose-600 rounded-lg text-white text-sm font-medium hover:bg-rose-700 transition">
                    Clear All Sales
                </button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="mx-auto max-w-6xl p-4 space-y-6">
        <!-- Summary Cards -->
        <section class="bg-white rounded-xl shadow border border-gray-200 p-4">
            <h2 class="text-lg font-semibold mb-3 text-gray-700">Today’s Summary</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <div class="rounded-lg bg-gray-100 p-4">
                    <div class="text-xs uppercase tracking-wide text-gray-500">Grand Total</div>
                    <div id="summaryTotal" class="text-2xl font-bold text-gray-800">$0.00</div>
                </div>
                <div class="rounded-lg bg-gray-100 p-4">
                    <div class="text-xs uppercase tracking-wide text-gray-500">Food Items</div>
                    <div id="summaryFood" class="text-2xl font-bold text-gray-800">0</div>
                </div>
                <div class="rounded-lg bg-gray-100 p-4">
                    <div class="text-xs uppercase tracking-wide text-gray-500">Drink Items</div>
                    <div id="summaryDrink" class="text-2xl font-bold text-gray-800">0</div>
                </div>
            </div>
            <div class="mt-4 flex flex-wrap gap-3">
                <button id="exportPdfBtn"
                    class="px-5 py-2.5 rounded-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 transition">
                    Download End-of-Day Report (PDF)
                </button>
            </div>
        </section>

        <!-- History List -->
        <section class="bg-white rounded-xl shadow border border-gray-200 p-4">
            <h2 class="text-lg font-semibold mb-3 text-gray-700">Today’s Transactions</h2>
            <div class="overflow-auto border border-gray-200 rounded-lg">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 text-gray-600">
                        <tr>
                            <th class="px-3 py-2 text-left">Time</th>
                            <th class="px-3 py-2 text-left">Items</th>
                            <th class="px-3 py-2 text-left">Payment</th>
                            <th class="px-3 py-2 text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
            <div id="emptyHistory" class="p-4 text-center text-gray-400 text-sm">No sales recorded today.</div>
        </section>
    </main>

    <!-- Inline JS -->
    <script>
        const STORAGE_KEY = 'simplePosSales';
        const $ = (sel) => document.querySelector(sel);

        function fmtCurrency(n) { return n.toLocaleString(undefined, { style: 'currency', currency: 'USD' }); }
        function todayStr() { return new Date().toISOString().slice(0, 10); }
        function loadSales() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }

        function refreshSummary() {
            const sales = loadSales().filter(r => r.date === todayStr());
            const grandTotal = sales.reduce((s, r) => s + r.totalAmount, 0);
            const food = sales.reduce((s, r) => s + (r.categorySummary.Food || 0), 0);
            const drink = sales.reduce((s, r) => s + (r.categorySummary.Drink || 0), 0);
            $('#summaryTotal').textContent = fmtCurrency(grandTotal);
            $('#summaryFood').textContent = food;
            $('#summaryDrink').textContent = drink;
            renderHistory(sales);
        }

        function renderHistory(sales) {
            const table = $('#historyTable');
            table.innerHTML = '';
            $('#emptyHistory').classList.toggle('hidden', sales.length > 0);

            sales.forEach(sale => {
                const time = new Date(sale.id).toLocaleTimeString();
                const itemsList = sale.items.map(it => `${it.name} x${it.qty}`).join(', ');
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td class="px-3 py-2">${time}</td>
          <td class="px-3 py-2">${itemsList}</td>
          <td class="px-3 py-2">${sale.paymentMethod || "N/A"}</td>
          <td class="px-3 py-2 text-right">${fmtCurrency(sale.totalAmount)}</td>
        `;
                table.appendChild(tr);
            });
        }

        // Generate PDF & Download locally
        function exportTodayToPDF() {
            const sales = loadSales().filter(r => r.date === todayStr());
            if (!sales.length) { alert('No sales today'); return; }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("p", "mm", "a4");

            // HEADER
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.text("ONE-SHOT Cafe", 105, 20, { align: "center" });
            doc.setFontSize(11);
            doc.text("One Shot Cafe, Street 608, Phnom Penh", 105, 28, { align: "center" });
            doc.text("Tel: +855 70 553 012", 105, 34, { align: "center" });

            doc.setDrawColor(200);
            doc.line(20, 40, 190, 40);

            // Report title
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("End of Day Sales Report", 105, 50, { align: "center" });
            doc.setFont("helvetica", "normal");
            doc.setFontSize(11);
            doc.text(`Date: ${todayStr()}`, 105, 58, { align: "center" });

            doc.line(20, 65, 190, 65);

            // Transactions
            let y = 75;
            sales.forEach((sale, index) => {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(11);
                doc.text(`Transaction #${index + 1}`, 20, y);
                doc.setFont("helvetica", "normal");
                doc.text(`${new Date(sale.id).toLocaleTimeString()}`, 190, y, { align: "right" });

                y += 6;
                sale.items.forEach(it => {
                    const lineTotal = (it.price * it.qty).toFixed(2);
                    doc.text(`- ${it.name} (x${it.qty})`, 25, y);
                    doc.text(`$${lineTotal}`, 190, y, { align: "right" });
                    y += 6;
                });

                doc.setFont("helvetica", "normal");
                doc.text(`Payment: ${sale.paymentMethod || "N/A"}`, 25, y);
                doc.setFont("helvetica", "bold");
                doc.text(`Total: $${sale.totalAmount.toFixed(2)}`, 190, y, { align: "right" });

                y += 10;
                if (y > 270) { doc.addPage(); y = 20; }
            });

            doc.line(20, y, 190, y);
            y += 10;

            // Summary totals
            const grandTotal = sales.reduce((s, r) => s + r.totalAmount, 0);
            const totalFood = sales.reduce((s, r) => s + (r.categorySummary.Food || 0), 0);
            const totalDrink = sales.reduce((s, r) => s + (r.categorySummary.Drink || 0), 0);

            doc.setFont("helvetica", "bold");
            doc.setFontSize(13);
            doc.text("Summary Totals", 20, y);
            y += 8;
            doc.setFont("helvetica", "normal");
            doc.text(`Food Items: ${totalFood}`, 20, y); y += 6;
            doc.text(`Drink Items: ${totalDrink}`, 20, y); y += 6;
            doc.text(`Grand Total: $${grandTotal.toFixed(2)}`, 20, y);

            y += 20;
            doc.setFont("helvetica", "italic");
            doc.setFontSize(11);
            doc.text("Thank you for a great day at ONE-SHOT Cafe", 105, y, { align: "center" });

            const fileName = `sales_summary_${todayStr()}.pdf`;
            doc.save(fileName);
        }

        function clearAllSales() {
            if (confirm("Are you sure you want to clear all sales history?")) {
                localStorage.removeItem(STORAGE_KEY);
                refreshSummary();
                alert("All sales history cleared!");
            }
        }

        function init() {
            refreshSummary();
            $('#exportPdfBtn').addEventListener('pointerup', exportTodayToPDF);
            $('#clearAllBtn').addEventListener('pointerup', clearAllSales);
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>